---
editor: 
  markdown: 
    wrap: 72
---

## Install/Load libraries

```{r echo=FALSE}

# library(gtrendsR)  # Downloading was blocked after 3 downloads
library(tidyverse)
library(lubridate)
library(sf)
library(rnaturalearth)
library(gtrendsR)
library(countrycode)

```

## prepare and merge data manually downloaded from Google Trends

```{r}

## Google Trends CSV-Dateien importieren und zusammenführen

## Funktion zum Einlesen und Aufbereiten der CSV-Dateien

process_trends_csv <- function(filepath, country_code) {
  # CSV einlesen und erste 2 Zeilen überspringen
  data <- read.csv(filepath, skip = 2, stringsAsFactors = FALSE)
  
  # Spaltennamen einheitlich setzen
  colnames(data) <- c("date", "iPhone", "Tesla", "Rolex")

  # <1 Werte in allen Trend-Spalten zu 0 ändern
  trend_columns <- c("iPhone", "Tesla", "Rolex")

  data <- data %>%
    mutate(across(all_of(trend_columns),
                  ~ as.numeric(str_replace(., "<1", "0"))))
    
  # Datum konvertieren
  data$date <- as.Date(data$date)
  
  # Country-Spalte hinzufügen
  data$country <- country_code
  
  return(data)
  }

```

## Alle drei CSV-Dateien einlesen

```{r}

trends_US <- process_trends_csv("./raw_data_from_google/multiTimeline_US.csv", "US")
trends_MX <- process_trends_csv("./raw_data_from_google/multiTimeline_MX.csv", "MX")
trends_DE <- process_trends_csv("./raw_data_from_google/multiTimeline_DE.csv", "DE")
trends_FR <- process_trends_csv("./raw_data_from_google/multiTimeline_FR.csv", "FR")
trends_JP <- process_trends_csv("./raw_data_from_google/multiTimeline_JP.csv", "JP")

## Alle Daten zusammenführen und nach Datum und Land sortieren
trends_combined <- rbind(trends_US, trends_MX, trends_DE, trends_FR, trends_JP) %>%
  arrange(date, country)

## Investigate the data
# str(trends_combined)
# head(trends_combined)
# View(trends_combined)
# summary(trends_combined)
# table(trends_combined$country)


## Daten in long format für Visualisierung
trends_long <- trends_combined %>%
  pivot_longer(
    cols = c(`iPhone`, `Tesla`, `Rolex`),
    names_to = "keyword",
    values_to = "hits"
  )

# head(trends_long, 10)
# View(trends_long)

```

# Speichern der kombinierten Daten

```{r}

# write.csv(trends_combined, "trends_combined_wide.csv", row.names = FALSE)
# write.csv(trends_long, "trends_combined_long.csv", row.names = FALSE)

```

## Facet line chart for all combinations of country & keyword.

```{r}

## Make the line graph with facets for all combinations

trends_long %>%
  ggplot(aes(x = date, y = hits)) +
  geom_line(colour = "darkblue", linewidth = .6) +
  labs(
    title = "Google Trends searches",
    y = "Relative importance on that day",
    caption = "Source: Google Trends (2017-11-14 to 2018-06-14)"
  ) +
  facet_wrap(~ country + keyword, nrow = 5, ncol = 3) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    panel.grid.minor = element_blank()
  )

```

## Scatterplot Keyword 1 vs. Keyword 2 for all countries

```{r echo=FALSE, message=FALSE}

## Make the scatter plot with fitted lm line

ggplot(trends_combined, aes(x = iPhone, y = Rolex)) +
  geom_point(alpha = 0.6, size = 2, color = "darkblue") +
  geom_smooth(method = 'lm', se = TRUE) +
  labs(
    title = "Correlation between iPhone and Rolex in Google Trends searches",
    x = "Tesla",
    y = "iPhone",
    caption = "Source: Google Trends. Each point represents a day from 2017-11-14 to 2018-06-14."
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    panel.grid.minor = element_blank()
  )

```

## Rolex bar chart with seasonality of Google Trends

```{r}

## Get and prepare the data

# res <- gtrends(
#   keyword = "Rolex",
#   geo     = "",
#   time    = "2018-01-01 2018-12-31")
# 
# write.csv(res$interest_over_time, "./raw_data_from_google/gtrends_Rolex_all_countries_year_2018.csv")

google_Rolex_2018 <- read.csv("./raw_data_from_google/gtrends_Rolex_all_countries_year_2018.csv")

plot_data <- google_Rolex_2018 %>% 
  select(date, hits) %>% 
  filter(date > "2018-01-01")

## Prepare month axis
# plot_data <- plot_data %>%
#   mutate(month_abbr = factor(month(month, label = TRUE, abbr = TRUE),
#                             levels = c("Nov", "Dez", "Jan", "Feb", "Mär", "Apr", "Mai", "Jun")))

## Make the bar chart

ggplot(plot_data, aes(x = date, y = hits)) +
  geom_col(fill = "darkblue") +
  labs(
    title = "Rolex searches worldwide 2018 by week",
    x = "Weeks 2018",
    y = "Relative search interest (100 for month with most searches",
    caption = "Source: Google Trends (2018-01-01 to 2018-12-31)"
  ) +
  scale_y_continuous(limits = c(0, 100)) +
  theme_minimal() +
  theme(
    axis.text.x = element_blank(),  # Remove x-axis text labels
    axis.ticks.x = element_blank()   # Remove x-axis ticks
  )

```

