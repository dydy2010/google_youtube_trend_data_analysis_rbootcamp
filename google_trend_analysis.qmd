---
editor: 
  markdown: 
    wrap: 72
---

## Install/Load libraries

```{r echo=FALSE}

# library(gtrendsR)  # Downloading was blocked after 3 downloads
library(tidyverse)
library(sf)
library(rnaturalearth)

```

## prepare and merge data manually downloaded

```{r}

# Google Trends CSV-Dateien importieren und zusammenführen

# Funktion zum Einlesen und Aufbereiten der CSV-Dateien

process_trends_csv <- function(filepath, country_code) {
  # CSV einlesen und erste 2 Zeilen überspringen
  data <- read.csv(filepath, skip = 2, stringsAsFactors = FALSE)
  
  # Spaltennamen einheitlich setzen
  colnames(data) <- c("date", "Donald_Trump", "Kendrick_Lamar", "Tesla", "NBA", "Amazon")

  # <1 Werte in allen Trend-Spalten zu 0 ändern
  trend_columns <- c("Donald_Trump", "Kendrick_Lamar", "Tesla", "NBA", "Amazon")

  data <- data %>%
    mutate(across(all_of(trend_columns),
                  ~ as.numeric(str_replace(., "<1", "0"))))
    
  # Datum konvertieren
  data$date <- as.Date(data$date)
  
  # Country-Spalte hinzufügen
  data$country <- country_code
  
  return(data)
  }

```

## Alle drei CSV-Dateien einlesen

```{r}

trends_US <- process_trends_csv("./raw_data_from_google/multiTimeline_US.csv", "US")
trends_UK <- process_trends_csv("./raw_data_from_google/multiTimeline_UK.csv", "UK")
trends_AU <- process_trends_csv("./raw_data_from_google/multiTimeline_AU.csv", "AU")

# Alle Daten zusammenführen und nach Datum und Land sortieren
trends_combined <- rbind(trends_US, trends_UK, trends_AU) %>%
  arrange(date, country)

# Investigate the data
# str(trends_combined)
# head(trends_combined)
# View(trends_combined)
# summary(trends_combined)
# table(trends_combined$country)
# dim(trends_combined)

# Daten in long format für Visualisierung
trends_long <- trends_combined %>%
  pivot_longer(
    cols = c(`Donald_Trump`, `Kendrick_Lamar`, `Tesla`, `NBA`, `Amazon`),
    names_to = "keyword",
    values_to = "hits"
  )

# head(trends_long, 10)

```

# Speichern der kombinierten Daten

```{r}

write.csv(trends_combined, "trends_combined_wide.csv", row.names = FALSE)
write.csv(trends_long, "trends_combined_long.csv", row.names = FALSE)

```

## Google Trends data

The numbers from 0 to 100 on Google Trends represent normalized,
relative search interest, not an absolute number of search queries. The
value 100 indicates the peak popularity of a search term in a selected
time period and region. All other values are relative to this peak
value. A value of 0 means that there is insufficient data or that the
search term has a very low search volume.

How the numbers work:

1.  Normalization: Google Trends normalizes the data on a scale from 0
    to 100 to represent search interest in relation to all search
    queries.
2.  Relative values: The numbers are not absolute quantities, but show
    how often a term was searched for in comparison to its own peak.
3.  The number 100: This represents the time or region when a search
    term reached its peak popularity.
4.  The number 0: This means that there was insufficient data for the
    search term at that time or in that region.
5.  Example: If a search term receives a 50, this means that search
    interest was only half as high as the peak value, which is 100.

Source:

## Facet line chart for all combinations of country & keyword.

```{r}

trends_long %>%
  ggplot(aes(x = date, y = hits)) +
  geom_line(colour = "darkblue", linewidth = .6) +
  facet_wrap(~ keyword + country, nrow = 5, ncol = 3) +
  theme_minimal()

```

## Scatterplot Keyword 1 vs. Keyword 2 for all countries

```{r}

ggplot(trends_combined, aes(x = Donald_Trump, y = NBA)) +
  geom_point(alpha = 0.6, size = 2, color = "darkblue") +
  geom_smooth(method = 'lm', se = TRUE) +
  labs(
    title = "Korrelation zwischen Suchanfragen",
    x = "Donald Trump",
    y = "NBA",
    caption = "Source: Google Trends"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    panel.grid.minor = element_blank()
  )

```

## Scatterplot Keyword 1 US vs. Keyword 1 DE

```{r}

```

## World map with Google Trends data for US, UK and Australia 

```{r}

# Aggregate the data by country
aggregated_data <- trends_combined %>%
  group_by(country) %>%
  summarise(Donald_Trump = mean(Donald_Trump, na.rm = TRUE))

# Get world map data
world_sf <- ne_countries(scale = "medium", returnclass = "sf")

# Prepare country code mapping (to join with world_sf)
country_mapping <- data.frame(
  country_code = c("AU", "US", "UK"),
  iso_a3 = c("AUS", "USA", "GBR")
)

# Join the aggregated data with world_sf
world_sf <- world_sf %>%
  left_join(aggregated_data %>% 
              left_join(country_mapping, by = c("country" = "country_code")),
            by = "iso_a3")

# Minimalist version
ggplot() +
  geom_sf(data = world_sf, 
          aes(fill = Donald_Trump), 
          color = "white") +
  scale_fill_gradient(
    low = "lightblue", 
    high = "darkblue",
    na.value = "lightgrey",
    name = "Interest"
  ) +
  labs(
    title = "Google Trends: Interest in Donald Trump",
    subtitle = "Average interest across time in US, UK and Australia (min = 0, max 100)",
    caption = "Data: Google Trends 2017-11-14 - 2018-06-14"
  ) +
  theme_bw() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())

```

```
